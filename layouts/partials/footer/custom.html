{{ partial "footer/aplayer.html" . }}
{{ partial "footer/pjax.html" . }}

<style>
  @font-face {
    font-family: 'WenYuanSerifSC-Regular';
    src: url({{ (resources.Get "font/WenYuanSerifSC-Regular.ttf").Permalink }}) format('truetype');
  }

  :root {
    --base-font-family: 'WenYuanSerifSC-Regular';
    --code-font-family: 'WenYuanSerifSC-Regular';
  }
</style>

<style>
    #TableOfContents > ul, ol {
        ul, ol {
            display: none;
        }
        .open {
            display: block;
        }
    }
</style>

<script>
    function initTocHide() {
        // 判断是否存在文章目录
        let toc = document.querySelector(".widget--toc");
        if (!toc) {
            return;
        }
        // 监听滚动
        window.addEventListener('scroll', function() {
            //清除class值
            let openUl = document.querySelectorAll(".open");
            if (openUl.length > 0) {
              openUl.forEach((ul) => {
                ul.classList.remove("open")
              })
            }
            // 获取active-class
            let currentLi = document.querySelector(".active-class");
            if (!currentLi) {
                return
            }
            // 展示子ul
            if (currentLi.children.length > 1) {
                currentLi.children[1].classList.add("open")
            }
            // 展示父ul
            let ul = currentLi.parentElement;
            do {
                ul.classList.add("open");
                ul = ul.parentElement.parentElement
            } while (ul !== undefined && (ul.localName === 'ul' || ul.localName === 'ol'))
        });
    }
    initTocHide()
</script>

<!-- 【custom.html】 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<div id="aplayer"></div>
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<script>
const ap = new APlayer({
    container: document.getElementById('aplayer'),
    audio: []
});
</script>

<!-- 【custom.html】 -->
...
<script>
    ...
    pjax._handleResponse = pjax.handleResponse;
    pjax.handleResponse = function(responseText, request, href, options) {
        if (request.responseText.match("<html")) {
            if (responseText) {
                // 将新页面的html字符串解析成DOM对象
                let newDom = new DOMParser().parseFromString(responseText, 'text/html');
                // 获取新页面中body的className，并设置回当前页面
                let bodyClass = newDom.body.className;
                document.body.setAttribute("class", bodyClass)
                // 放行，交给pjax自己处理
                pjax._handleResponse(responseText, request, href, options);
            }
        } else {
            // handle non-HTML response here
        }
    }
</script>


<script>
function updateRunningTime() {
    const el = document.getElementById('runningdays');
    if (!el) return;

    let s1 = '2026-1-12';
    s1 = new Date(s1.replace(/-/g, "/"));
    let s2 = new Date();

    let timeDifference = s2.getTime() - s1.getTime();

    let days = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
    let hours = Math.floor((timeDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    let minutes = Math.floor((timeDifference % (1000 * 60 * 60)) / (1000 * 60));

    el.textContent = days + "天" + hours + "小时" + minutes + "分钟";
}
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    updateRunningTime();
});
</script>
<script>
document.addEventListener("pjax:complete", function () {
    updateRunningTime();
});
</script>

<!-- 扩大主页文章卡片可点击区域（排除分类链接） -->
<script>
document.addEventListener('click', function (e) {
    const article = e.target.closest('article');
    if (!article) return;

    // 点击在分类 / 标签 / 任意 a 上，直接放行
    if (e.target.closest('.article-category a, .article-tags a, a')) {
        return;
    }

    const titleLink = article.querySelector('.article-title a');
    if (titleLink && titleLink.href) {
        window.location.href = titleLink.href;
    }
}, true); // ← 注意：capture 阶段
</script>

<script>
(function () {
  function scrollToHash() {
    if (!window.location.hash) return;

    // 去掉 ?t=xxx 等参数
    const id = window.location.hash.substring(1).split('?')[0];

    // 等待目标元素出现
    const interval = setInterval(() => {
      const target = document.getElementById(id);
      if (target) {
        clearInterval(interval);
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }, 50); // 每 50ms 检查一次
  }

  // 页面初次加载
  document.addEventListener('DOMContentLoaded', scrollToHash);

  // 监听 hash 变化
  window.addEventListener('hashchange', scrollToHash);

  // 监听 Stack PJAX 完全加载
  document.addEventListener('pjax:end', function () {
    // 延迟 50ms 再滚，确保 DOM 完全渲染
    setTimeout(scrollToHash, 50);
  });
})();
</script>
